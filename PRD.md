# Product Requirements Document: WhatsApp Groups Monitoring System

## 1. Overview

A WhatsApp monitoring system that connects to a single WhatsApp account, monitors all group chats, records messages throughout the day, and sends daily summaries to a specified phone number.

## 2. Objectives

- Monitor all WhatsApp groups associated with a connected account
- Store messages with embeddings for semantic analysis
- Generate daily summaries of group activities
- Send consolidated summaries to a specified phone number at a scheduled time

## 3. Technical Stack

### Core Components
- **WhatsApp Interface**: `aldinokemal2104/go-whatsapp-web-multidevice` (Docker)
- **Database**: PostgreSQL with pgvector extension
- **Embeddings**: `gemini-embedding-001`
- **LLM**: `models/gemini-flash-latest` (Gemini)
- **Deployment**: Railway

### Programming Languages & Frameworks
- Python 3.11+
- FastAPI or Flask for API layer (if needed)
- SQLAlchemy/SQLModel for ORM
- APScheduler for scheduling
- Google Generative AI SDK

## 4. System Architecture

### 4.1 Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WhatsApp Web   â”‚
â”‚   (Docker)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Message        â”‚
â”‚  Collector      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL     â”‚â—„â”€â”€â”€â”€â”€â”¤  Embedding   â”‚
â”‚  + pgvector     â”‚      â”‚  Generator   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Scheduler      â”‚
â”‚  (20:00 UTC+3)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Summary        â”‚â”€â”€â”€â”€â”€â–ºâ”‚  Gemini LLM  â”‚
â”‚  Generator      â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WhatsApp       â”‚
â”‚  Sender         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5. Functional Requirements

### 5.1 WhatsApp Connection
- **FR-1.1**: System must connect to WhatsApp using QR code scan (one-time setup)
- **FR-1.2**: Connection must persist and auto-reconnect on disconnection
- **FR-1.3**: System must load all groups the account is part of on initial connection
- **FR-1.4**: System must handle new groups added to the account dynamically

### 5.2 Message Collection
- **FR-2.1**: Record every new message in real-time from all monitored groups
- **FR-2.2**: Store message metadata:
  - Message ID
  - Group ID (JID)
  - Group Name
  - Sender ID (JID)
  - Sender Name
  - Message content/text
  - Timestamp
  - Message type (text, image, video, etc.)
- **FR-2.3**: Generate embeddings for each text message using `gemini-embedding-001`
- **FR-2.4**: Store embeddings in PostgreSQL with pgvector
- **FR-2.5**: Skip messages sent by the bot itself

### 5.3 Data Storage
- **FR-3.1**: Database schema must support:
  - Groups table (group_jid, group_name, last_summary_sync, managed)
  - Messages table (message_id, group_jid, sender_jid, sender_name, content, timestamp, embedding)
- **FR-3.2**: Use pgvector for storing and querying embeddings (vector[768] for gemini-embedding-001)
- **FR-3.3**: Index messages by group and timestamp
- **FR-3.4**: Support vector similarity search for semantic queries

### 5.4 Daily Summary Generation
- **FR-4.1**: Schedule summary generation daily at 20:00 UTC+3 (17:00 UTC)
- **FR-4.2**: For each group:
  - Retrieve all messages since last summary (or since midnight if first summary)
  - Generate summary using Gemini Flash with context of all messages
  - Use casual conversational writing style
  - Detect and use the same language as the group chat
  - Tag users when mentioned (e.g., @972536150150)
- **FR-4.3**: Only generate summary if minimum threshold of messages exists (e.g., 15+ messages)
- **FR-4.4**: Consolidate all group summaries into single message
- **FR-4.5**: Send consolidated summary to configured phone number

### 5.5 Summary Format
```
ğŸ“± Daily WhatsApp Groups Summary - [Date]

ğŸ“Œ [Group Name 1]
[Summary of group 1 activity]

ğŸ“Œ [Group Name 2]
[Summary of group 2 activity]

...

---
Generated by WhatsApp Groups Monitor
```

### 5.6 Error Handling & Reliability
- **FR-6.1**: Implement retry logic with exponential backoff for:
  - WhatsApp API calls
  - Embedding generation
  - LLM calls
  - Database operations
- **FR-6.2**: Log all errors with context
- **FR-6.3**: Continue processing other groups if one fails
- **FR-6.4**: Store failed summary attempts for manual review

## 6. Non-Functional Requirements

### 6.1 Performance
- **NFR-1.1**: Process incoming messages within 5 seconds
- **NFR-1.2**: Generate embeddings asynchronously to avoid blocking message collection
- **NFR-1.3**: Summary generation should complete within 10 minutes for up to 50 groups

### 6.2 Scalability
- **NFR-2.1**: Support monitoring up to 100 groups simultaneously
- **NFR-2.2**: Handle up to 10,000 messages per day across all groups

### 6.3 Availability
- **NFR-3.1**: System uptime target: 99%
- **NFR-3.2**: Auto-restart on crashes
- **NFR-3.3**: Graceful degradation if embedding service fails

### 6.4 Security
- **NFR-4.1**: Store sensitive credentials as environment variables
- **NFR-4.2**: No message content should be logged
- **NFR-4.3**: Database connections must use SSL
- **NFR-4.4**: WhatsApp session data must be persisted securely

## 7. Configuration

### 7.1 Environment Variables
```env
# WhatsApp
WHATSAPP_API_URL=http://whatsapp-api:3000
WHATSAPP_API_KEY=<api-key>

# Database
DATABASE_URL=postgresql://user:pass@host:5432/dbname

# Gemini
GOOGLE_API_KEY=<gemini-api-key>
GEMINI_EMBEDDING_MODEL=models/gemini-embedding-001
GEMINI_LLM_MODEL=models/gemini-flash-latest

# Notifications
SUMMARY_RECIPIENT_PHONE=+972542607800
SUMMARY_SCHEDULE_HOUR=20
SUMMARY_SCHEDULE_TIMEZONE=Asia/Jerusalem  # UTC+3

# Application
LOG_LEVEL=INFO
MINIMUM_MESSAGES_FOR_SUMMARY=15
```

## 8. User Stories

### 8.1 Initial Setup
**As a user**, I want to connect my WhatsApp account once via QR code, so the system can monitor all my groups without repeated authentication.

### 8.2 Continuous Monitoring
**As a user**, I want the system to automatically record all messages from my groups throughout the day, so I don't miss any important conversations.

### 8.3 Daily Digest
**As a user**, I want to receive a consolidated summary of all group activities at 20:00 every day, so I can quickly catch up on what I missed.

### 8.4 Smart Summaries
**As a user**, I want summaries in the same language as the group chat with user mentions, so the summary feels natural and contextual.

## 9. Implementation Phases

### Phase 1: Core Infrastructure (Week 1)
- Set up PostgreSQL with pgvector
- Set up WhatsApp Web Docker container
- Create database models and migrations
- Implement WhatsApp client wrapper

### Phase 2: Message Collection (Week 1-2)
- Implement message webhook/polling
- Create message storage pipeline
- Implement embedding generation (async)
- Test with sample groups

### Phase 3: Summary Generation (Week 2)
- Implement Gemini LLM integration
- Create summary generation logic
- Format consolidated summaries
- Test summary quality

### Phase 4: Scheduling & Delivery (Week 2-3)
- Implement APScheduler for daily summaries
- Create summary sending logic
- Add error handling and retries
- End-to-end testing

### Phase 5: Deployment (Week 3)
- Create Railway deployment configuration
- Set up environment variables
- Deploy and test in production
- Monitor and optimize

## 10. Success Metrics

- **Reliability**: 99% message capture rate
- **Accuracy**: Summaries accurately reflect group conversations
- **Timeliness**: Daily summaries delivered within 5 minutes of scheduled time
- **Quality**: Less than 5% summary regeneration requests
- **Performance**: No message processing lag during peak hours

## 11. Future Enhancements

- Web dashboard for viewing summaries
- On-demand summary generation via command
- Semantic search across all messages
- Analytics and insights (most active groups, trending topics)
- Custom summary schedules per group
- Multi-language summary translation
- Integration with other messaging platforms

## 12. Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|-----------|
| WhatsApp API rate limits | High | Implement request throttling and queuing |
| Gemini API quota exceeded | High | Monitor usage, implement fallback strategies |
| Database storage growth | Medium | Implement message retention policies |
| WhatsApp session expires | High | Auto-reconnect logic with alerting |
| Railway deployment limits | Medium | Monitor resource usage, optimize queries |

## 13. Dependencies

- Docker & Docker Compose
- PostgreSQL 15+ with pgvector extension
- Python 3.11+
- Google Cloud API access (Gemini)
- Railway account for deployment
- Active WhatsApp account

## 14. Assumptions

- User has a stable internet connection
- WhatsApp account is not banned/restricted
- Groups don't exceed WhatsApp's technical limits
- User has appropriate permissions in monitored groups
- Gemini API provides consistent response times

## 15. Open Questions

1. Should we support filtering which groups to monitor?
2. How long should we retain message history?
3. Should summaries be stored for future reference?
4. Do we need a web interface for configuration?
5. Should we support multiple WhatsApp accounts?
